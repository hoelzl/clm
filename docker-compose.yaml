name: clx

# Simplified Docker Compose for CLX with SQLite backend
# Workers now use SQLite for job queue instead of RabbitMQ
# For legacy RabbitMQ setup, see docker-compose.legacy.yaml
#
# NOTE: After building with `docker compose build`, run `./tag-compose-images.sh`
#       (or `.\tag-compose-images.ps1` on Windows) to also create :latest tags.
#       This ensures compatibility with both versioned and :latest tag references.

services:
    notebook-processor:
        build:
            context: .
            dockerfile: services/notebook-processor/Dockerfile
            args:
                SERVICE_PATH: ./services/notebook-processor
                COMMON_PATH: .
            tags:
                - "mhoelzl/clx-notebook-processor:0.3.0"
                - "mhoelzl/clx-notebook-processor:latest"
        image: mhoelzl/clx-notebook-processor:0.3.0
        networks:
            - app-network
        environment:
            - LOG_LEVEL=INFO
            - DB_PATH=/data/clx_jobs.db
        volumes:
            - clx-data:/data
        deploy:
            mode: replicated
            replicas: 1

    drawio-converter:
        build:
            context: .
            dockerfile: services/drawio-converter/Dockerfile
            args:
                SERVICE_PATH: ./services/drawio-converter
                COMMON_PATH: .
            tags:
                - "mhoelzl/clx-drawio-converter:0.3.0"
                - "mhoelzl/clx-drawio-converter:latest"
        image: mhoelzl/clx-drawio-converter:0.3.0
        environment:
            - LOG_LEVEL=INFO
            - DISPLAY=:99
            - DB_PATH=/data/clx_jobs.db
        volumes:
            - clx-data:/data
        networks:
            - app-network
        init: true
        deploy:
            mode: replicated
            replicas: 1

    plantuml-converter:
        build:
            context: .
            dockerfile: services/plantuml-converter/Dockerfile
            args:
                SERVICE_PATH: ./services/plantuml-converter
                COMMON_PATH: .
            tags:
                - "mhoelzl/clx-plantuml-converter:0.3.0"
                - "mhoelzl/clx-plantuml-converter:latest"
        image: mhoelzl/clx-plantuml-converter:0.3.0
        environment:
            - LOG_LEVEL=INFO
            - DB_PATH=/data/clx_jobs.db
        volumes:
            - clx-data:/data
        networks:
            - app-network
        deploy:
            mode: replicated
            replicas: 1

networks:
    app-network:
        driver: bridge

volumes:
    clx-data:
