name: clx

# Simplified Docker Compose for CLX with SQLite backend
# Workers now use SQLite for job queue instead of RabbitMQ
# For legacy RabbitMQ setup, see docker-compose.legacy.yaml
#
# NOTEBOOK VARIANTS:
#   The notebook-processor service supports two variants:
#   - full (default): CUDA/PyTorch support, ~10GB, amd64 only
#   - lite: No ML libraries, ~3GB, multi-arch (amd64 + arm64)
#
#   To use the lite variant, set the NOTEBOOK_VARIANT environment variable:
#     NOTEBOOK_VARIANT=lite docker compose up
#
#   Or override in docker-compose.override.yaml
#
# NOTE: After building with `docker compose build`, run `./tag-compose-images.sh`
#       (or `.\tag-compose-images.ps1` on Windows) to also create :latest tags.
#       This ensures compatibility with both versioned and :latest tag references.

services:
    notebook-processor:
        build:
            context: .
            dockerfile: docker/notebook/Dockerfile
            args:
                DOCKER_PATH: ./docker/notebook
                # Default to full variant for backward compatibility
                VARIANT: ${NOTEBOOK_VARIANT:-full}
            tags:
                - "mhoelzl/clx-notebook-processor:0.5.0"
                - "mhoelzl/clx-notebook-processor:latest"
        # Use variant-specific tag if NOTEBOOK_VARIANT is set
        image: mhoelzl/clx-notebook-processor:${NOTEBOOK_VARIANT:-0.5.0}
        networks:
            - app-network
        environment:
            - LOG_LEVEL=INFO
            - DB_PATH=/data/clx_jobs.db
            - PYTHONUNBUFFERED=1
        volumes:
            - clx-data:/data
        deploy:
            mode: replicated
            replicas: 1

    drawio-converter:
        build:
            context: .
            dockerfile: docker/drawio/Dockerfile
            args:
                DOCKER_PATH: ./docker/drawio
            tags:
                - "mhoelzl/clx-drawio-converter:0.5.0"
                - "mhoelzl/clx-drawio-converter:latest"
        image: mhoelzl/clx-drawio-converter:0.5.0
        environment:
            - LOG_LEVEL=INFO
            - DISPLAY=:99
            - DB_PATH=/data/clx_jobs.db
            - PYTHONUNBUFFERED=1
        volumes:
            - clx-data:/data
        networks:
            - app-network
        init: true
        deploy:
            mode: replicated
            replicas: 1

    plantuml-converter:
        build:
            context: .
            dockerfile: docker/plantuml/Dockerfile
            args:
                DOCKER_PATH: ./docker/plantuml
            tags:
                - "mhoelzl/clx-plantuml-converter:0.5.0"
                - "mhoelzl/clx-plantuml-converter:latest"
        image: mhoelzl/clx-plantuml-converter:0.5.0
        environment:
            - LOG_LEVEL=INFO
            - DB_PATH=/data/clx_jobs.db
            - PYTHONUNBUFFERED=1
        volumes:
            - clx-data:/data
        networks:
            - app-network
        deploy:
            mode: replicated
            replicas: 1

networks:
    app-network:
        driver: bridge

volumes:
    clx-data:
