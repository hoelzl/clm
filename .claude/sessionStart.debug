#!/bin/bash
# SessionStart hook for CLX project - INSTRUMENTED DEBUG VERSION
# This script runs when a new Claude Code session starts
# Logs everything to /tmp/clx_session_start.log for debugging

LOG_FILE="/tmp/clx_session_start.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "==================================="
echo "CLX SessionStart Hook - DEBUG MODE"
echo "==================================="
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo "Working directory: $(pwd)"
echo "User: $(whoami)"
echo "-----------------------------------"

set -e
set -x  # Enable command tracing

echo "=== Environment Variables ==="
env | grep -E "CLAUDE|USER|DISPLAY|PLANTUML" | sort || echo "No relevant env vars found"
echo ""

# Check if running in a remote environment (Claude Code on the web)
echo "=== Environment Detection ==="
if [ -n "$CLAUDE_CODE_SESSION_ID" ]; then
    echo "✓ CLAUDE_CODE_SESSION_ID is set: $CLAUDE_CODE_SESSION_ID"
fi
if [ -n "$CLAUDE_SESSION_ID" ]; then
    echo "✓ CLAUDE_SESSION_ID is set: $CLAUDE_SESSION_ID"
fi
if [ -n "$CLAUDE_CODE_REMOTE" ]; then
    echo "✓ CLAUDE_CODE_REMOTE is set: $CLAUDE_CODE_REMOTE"
fi
if [ "$USER" = "claude" ]; then
    echo "✓ USER is 'claude'"
fi
if [ "$(whoami)" = "root" ]; then
    echo "✓ Running as root"
fi
echo ""

if [ -n "$CLAUDE_CODE_SESSION_ID" ] || [ -n "$CLAUDE_SESSION_ID" ] || [ -n "$CLAUDE_CODE_REMOTE" ] || [ "$USER" = "claude" ] || [ "$(whoami)" = "root" ]; then
    echo "Remote environment detected. Installing dependencies..."
    echo ""

    # Install dependencies from requirements.txt
    echo "=== Step 1: Installing requirements from requirements.txt ==="
    echo "Command: python -m pip install -q -r requirements.txt"
    python -m pip install -q -r requirements.txt
    echo "✓ Step 1 complete"
    echo ""

    # Install local packages in editable mode
    echo "=== Step 2: Installing local packages in editable mode ==="
    echo "Command: python -m pip install -q -e ./clx-common"
    python -m pip install -q -e ./clx-common
    echo "✓ clx-common installed"

    echo "Command: python -m pip install -q -e ./clx"
    python -m pip install -q -e ./clx
    echo "✓ clx installed"

    echo "Command: python -m pip install -q -e ./clx-faststream-backend"
    python -m pip install -q -e ./clx-faststream-backend
    echo "✓ clx-faststream-backend installed"

    echo "Command: python -m pip install -q -e ./clx-cli"
    python -m pip install -q -e ./clx-cli
    echo "✓ clx-cli installed"
    echo "✓ Step 2 complete"
    echo ""

    # Install services as editable packages
    echo "=== Step 3: Installing service packages in editable mode ==="
    echo "Command: python -m pip install -q -e ./services/notebook-processor"
    python -m pip install -q -e ./services/notebook-processor
    echo "✓ notebook-processor installed"

    echo "Command: python -m pip install -q -e ./services/drawio-converter"
    python -m pip install -q -e ./services/drawio-converter
    echo "✓ drawio-converter installed"

    echo "Command: python -m pip install -q -e ./services/plantuml-converter"
    python -m pip install -q -e ./services/plantuml-converter
    echo "✓ plantuml-converter installed"
    echo "✓ Step 3 complete"
    echo ""

    echo "✓ Dependencies installed successfully"
    echo ""

    # Install DrawIO for native worker support
    echo "=== Step 4: Setting up DrawIO converter ==="
    if ! command -v drawio &> /dev/null; then
        echo "  Installing DrawIO..."
        DRAWIO_VERSION="24.7.5"
        DRAWIO_DEB="/tmp/drawio-amd64-${DRAWIO_VERSION}.deb"

        if [ ! -f "$DRAWIO_DEB" ]; then
            echo "  Downloading DrawIO from GitHub..."
            wget -q "https://github.com/jgraph/drawio-desktop/releases/download/v${DRAWIO_VERSION}/drawio-amd64-${DRAWIO_VERSION}.deb" -O "$DRAWIO_DEB"
            echo "  ✓ Download complete"
        else
            echo "  ✓ DrawIO .deb already downloaded"
        fi

        # Extract drawio binary from .deb
        echo "  Extracting DrawIO binary..."
        dpkg -x "$DRAWIO_DEB" /tmp/drawio-extract
        ln -sf /tmp/drawio-extract/opt/drawio/drawio /usr/local/bin/drawio
        echo "  ✓ DrawIO installed"
    else
        echo "  ✓ DrawIO already installed at: $(which drawio)"
    fi
    echo "✓ Step 4 complete"
    echo ""

    # Start Xvfb for headless DrawIO operation
    echo "=== Step 5: Starting Xvfb for DrawIO ==="
    if ! pgrep -x "Xvfb" > /dev/null; then
        echo "  Starting Xvfb..."
        Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &>/tmp/xvfb.log &
        export DISPLAY=:99
        sleep 2  # Give Xvfb time to start
        echo "  ✓ Xvfb started on display :99"
    else
        echo "  ✓ Xvfb already running (PID: $(pgrep -x Xvfb))"
        export DISPLAY=:99
    fi
    echo "✓ Step 5 complete"
    echo ""

    # Install PlantUML for native worker support
    echo "=== Step 6: Setting up PlantUML converter ==="
    PLANTUML_VERSION="1.2024.6"
    PLANTUML_JAR="/usr/local/share/plantuml-${PLANTUML_VERSION}.jar"

    if [ ! -f "$PLANTUML_JAR" ]; then
        echo "  Downloading PlantUML from GitHub..."
        wget -q "https://github.com/plantuml/plantuml/releases/download/v${PLANTUML_VERSION}/plantuml-${PLANTUML_VERSION}.jar" -O "$PLANTUML_JAR"
        echo "  ✓ PlantUML installed at $PLANTUML_JAR"
    else
        echo "  ✓ PlantUML already installed at: $PLANTUML_JAR"
    fi

    # Create a wrapper script for plantuml command
    if [ ! -f /usr/local/bin/plantuml ]; then
        echo "  Creating PlantUML wrapper script..."
        cat > /usr/local/bin/plantuml << 'EOF'
#!/bin/bash
PLANTUML_JAR="/usr/local/share/plantuml-1.2024.6.jar"
exec java -DPLANTUML_LIMIT_SIZE=8192 -jar "$PLANTUML_JAR" "$@"
EOF
        chmod +x /usr/local/bin/plantuml
        echo "  ✓ PlantUML wrapper script created at /usr/local/bin/plantuml"
    else
        echo "  ✓ PlantUML wrapper script already exists"
    fi
    echo "✓ Step 6 complete"
    echo ""

    # Set environment variables for native workers
    echo "=== Step 7: Setting environment variables ==="
    export PLANTUML_JAR="/usr/local/share/plantuml-${PLANTUML_VERSION}.jar"
    export DISPLAY=:99
    echo "  PLANTUML_JAR=$PLANTUML_JAR"
    echo "  DISPLAY=$DISPLAY"
    echo "✓ Step 7 complete"
    echo ""

    echo "✓ Environment variables set for native workers"
else
    echo "Local environment detected. Skipping dependency installation."
    echo "To install dependencies manually, run:"
    echo "  pip install -r requirements.txt"
    echo "  pip install -e ./clx-common -e ./clx -e ./clx-faststream-backend -e ./clx-cli"
    echo "  pip install -e ./services/notebook-processor -e ./services/drawio-converter -e ./services/plantuml-converter"
    echo ""
    echo "For native worker support, also install:"
    echo "  1. DrawIO: Download from https://github.com/jgraph/drawio-desktop/releases"
    echo "  2. PlantUML: Download JAR from https://github.com/plantuml/plantuml/releases"
    echo "  3. Ensure Xvfb is running for DrawIO: Xvfb :99 -screen 0 1024x768x24 &"
    echo "  4. Set DISPLAY=:99 environment variable"
fi

echo ""
echo "==================================="
echo "CLX SessionStart Hook Complete"
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo "==================================="
echo ""
echo "Log file location: $LOG_FILE"
echo "To view the log: cat $LOG_FILE"
echo ""
