#!/bin/bash
# SessionStart hook for CLX project - OPTIMIZED VERSION
# This script runs when a new Claude Code session starts
# Optimizations:
#   - Sequential pip installations (fixes dependency resolution)
#   - Uses local files (no network downloads needed)
#   - Better output flushing
#   - Uses repository-local PlantUML JAR and DrawIO deb

LOG_FILE="/tmp/clx_session_start.log"

# Use unbuffered output to ensure logs are complete
exec > >(stdbuf -oL -eL tee -a "$LOG_FILE") 2>&1

echo "==================================="
echo "CLX SessionStart Hook - OPTIMIZED"
echo "==================================="
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo "Working directory: $(pwd)"
echo "User: $(whoami)"
echo "-----------------------------------"
echo ""

# Exit on error
set -e

# Check if running in a remote environment (Claude Code on the web)
echo "=== Environment Detection ==="
if [ -n "$CLAUDE_CODE_SESSION_ID" ]; then
    echo "✓ CLAUDE_CODE_SESSION_ID is set: $CLAUDE_CODE_SESSION_ID"
fi
if [ -n "$CLAUDE_SESSION_ID" ]; then
    echo "✓ CLAUDE_SESSION_ID is set: $CLAUDE_SESSION_ID"
fi
if [ -n "$CLAUDE_CODE_REMOTE" ]; then
    echo "✓ CLAUDE_CODE_REMOTE is set: $CLAUDE_CODE_REMOTE"
fi
if [ "$USER" = "claude" ]; then
    echo "✓ USER is 'claude'"
fi
if [ "$(whoami)" = "root" ]; then
    echo "✓ Running as root"
fi
echo ""

if [ -n "$CLAUDE_CODE_SESSION_ID" ] || [ -n "$CLAUDE_SESSION_ID" ] || [ -n "$CLAUDE_CODE_REMOTE" ] || [ "$USER" = "claude" ] || [ "$(whoami)" = "root" ]; then
    echo "Remote environment detected. Installing dependencies..."
    echo ""

    # Install dependencies from requirements.txt
    echo "=== Step 1: Installing requirements from requirements.txt ==="
    python -m pip install -q -r requirements.txt
    echo "✓ Step 1 complete"
    echo ""

    # Install local packages in SEQUENTIAL order (fixes dependency resolution)
    echo "=== Step 2: Installing local packages in editable mode (SEQUENTIAL) ==="

    echo "Installing clx-common..."
    python -m pip install -q -e ./clx-common
    echo "✓ clx-common installed"

    echo "Installing clx..."
    python -m pip install -q -e ./clx
    echo "✓ clx installed"

    echo "Installing clx-faststream-backend..."
    python -m pip install -q -e ./clx-faststream-backend
    echo "✓ clx-faststream-backend installed"

    echo "Installing clx-cli..."
    python -m pip install -q -e ./clx-cli
    echo "✓ clx-cli installed"

    echo "✓ Step 2 complete (all packages installed)"
    echo ""

    # Install service packages (can be parallel since no interdependencies)
    echo "=== Step 3: Installing service packages in editable mode ==="

    echo "Installing notebook-processor..."
    python -m pip install -q -e ./services/notebook-processor
    echo "✓ notebook-processor installed"

    echo "Installing drawio-converter..."
    python -m pip install -q -e ./services/drawio-converter
    echo "✓ drawio-converter installed"

    echo "Installing plantuml-converter..."
    python -m pip install -q -e ./services/plantuml-converter
    echo "✓ plantuml-converter installed"

    echo "✓ Step 3 complete (all service packages installed)"
    echo ""

    echo "✓ Core dependencies installed successfully"
    echo ""

    # Install DrawIO for native worker support (using local deb file)
    echo "=== Step 4: Setting up DrawIO converter ==="
    if ! command -v drawio &> /dev/null; then
        echo "  Installing DrawIO from local .deb file..."
        DRAWIO_DEB="$PWD/services/drawio-converter/drawio-amd64-24.7.5.deb"

        if [ ! -f "$DRAWIO_DEB" ]; then
            echo "  ✗ ERROR: DrawIO deb not found at $DRAWIO_DEB"
            exit 1
        fi

        # Extract drawio binary from .deb
        echo "  Extracting DrawIO binary..."
        dpkg -x "$DRAWIO_DEB" /tmp/drawio-extract
        ln -sf /tmp/drawio-extract/opt/drawio/drawio /usr/local/bin/drawio
        echo "  ✓ DrawIO installed at /usr/local/bin/drawio"
    else
        echo "  ✓ DrawIO already installed at: $(which drawio)"
    fi
    echo "✓ Step 4 complete"
    echo ""

    # Install PlantUML for native worker support (using local JAR file)
    echo "=== Step 5: Setting up PlantUML converter ==="
    PLANTUML_VERSION="1.2024.6"
    PLANTUML_JAR="/usr/local/share/plantuml-${PLANTUML_VERSION}.jar"
    REPO_PLANTUML_JAR="$PWD/services/plantuml-converter/plantuml-${PLANTUML_VERSION}.jar"

    if [ ! -f "$PLANTUML_JAR" ]; then
        echo "  Installing PlantUML from local JAR file..."

        if [ ! -f "$REPO_PLANTUML_JAR" ]; then
            echo "  ✗ ERROR: PlantUML JAR not found at $REPO_PLANTUML_JAR"
            exit 1
        fi

        cp "$REPO_PLANTUML_JAR" "$PLANTUML_JAR"
        echo "  ✓ PlantUML installed at $PLANTUML_JAR"
    else
        echo "  ✓ PlantUML already installed at: $PLANTUML_JAR"
    fi

    # Create a wrapper script for plantuml command
    if [ ! -f /usr/local/bin/plantuml ]; then
        echo "  Creating PlantUML wrapper script..."
        cat > /usr/local/bin/plantuml << 'EOF'
#!/bin/bash
PLANTUML_JAR="/usr/local/share/plantuml-1.2024.6.jar"
exec java -DPLANTUML_LIMIT_SIZE=8192 -jar "$PLANTUML_JAR" "$@"
EOF
        chmod +x /usr/local/bin/plantuml
        echo "  ✓ PlantUML wrapper script created at /usr/local/bin/plantuml"
    else
        echo "  ✓ PlantUML wrapper script already exists"
    fi
    echo "✓ Step 5 complete"
    echo ""

    # Set environment variables for native workers
    echo "=== Step 6: Setting environment variables ==="
    export PLANTUML_JAR="/usr/local/share/plantuml-${PLANTUML_VERSION}.jar"
    echo "  PLANTUML_JAR=$PLANTUML_JAR"
    echo ""
    echo "NOTE: DISPLAY environment variable should be set to :99 for DrawIO to work."
    echo "      You must start Xvfb manually. See CLAUDE.md for instructions."
    echo "✓ Step 6 complete"
    echo ""

    echo "✓ Environment setup complete"
else
    echo "Local environment detected. Skipping dependency installation."
    echo "To install dependencies manually, run:"
    echo "  pip install -r requirements.txt"
    echo "  pip install -e ./clx-common -e ./clx -e ./clx-faststream-backend -e ./clx-cli"
    echo "  pip install -e ./services/notebook-processor -e ./services/drawio-converter -e ./services/plantuml-converter"
    echo ""
    echo "For native worker support, see CLAUDE.md for setup instructions."
fi

# Flush all output
sync

echo ""
echo "==================================="
echo "CLX SessionStart Hook Complete"
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo "==================================="
echo ""
echo "Log file: $LOG_FILE"
echo ""
